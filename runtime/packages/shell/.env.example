# Copy to `.env` and configure (never commit real secrets).

#####################
# Core App Settings  #
#####################

ENV=development

# Frontend origin for CORS (use exact origin, no trailing slash)
FRONTEND_URL=http://localhost:5173
ADDITIONAL_CORS_ORIGINS=

# Optional: override browser-derived WS base URL (use ws:// or wss://, no trailing slash).
VITE_WS_BASE_URL=

# Production-required host allowlist (comma-separated).
ALLOWED_HOSTS=localhost,127.0.0.1

# API docs exposure (disable in production).
OPENAPI_ENABLED=true
DEBUG_ENDPOINTS_ENABLED=true

# Only enable if you use cookie-based auth.
CORS_ALLOW_CREDENTIALS=false

#################
# Auth / Tokens #
#################

# ┌─────────────────────────────────────────────────────────────────────────┐
# │ AUTH MODE QUICK REFERENCE                                               │
# │                                                                         │
# │ external (DEFAULT): Self-hosted with your own IdP (JWKS validation)     │
# │ platform: Mozaiks-hosted deployments (CIAM-only, auto-configured)       │
# │ local: OPT-IN ONLY — development/offline/air-gapped environments        │
# │                                                                         │
# │ ⚠️  SECURITY INVARIANTS:                                                │
# │ • Platform/external modes derive identity from JWT sub (server-side)    │
# │ • Platform/external modes NEVER use local identity paths                │
# │ • Local mode is EXPLICITLY ISOLATED and must be opted into              │
# │ • Mozaiks platform distribution is CIAM-only (platform mode)            │
# │                                                                         │
# │ external/platform = OIDC redirect + JWKS validation (no passwords)      │
# │ local = username/password (⚠️ NOT for production deployments)           │
# └─────────────────────────────────────────────────────────────────────────┘

# Auth modes (backend): platform | external | local
# Default: external
MOZAIKS_AUTH_MODE=external

# Auth modes (frontend, Vite build-time): platform | external | local
VITE_MOZAIKS_AUTH_MODE=external

# Optional token exchange (must match backend).
# - 0: backend accepts the external OIDC token directly
# - 1: frontend calls /api/auth/token-exchange and then uses the app-scoped token
VITE_MOZAIKS_TOKEN_EXCHANGE=0

# OIDC login (frontend, redirect-based) for platform/external modes
VITE_AUTH_AUTHORITY=
VITE_AUTH_CLIENT_ID=
VITE_AUTH_REDIRECT_URI=http://localhost:5173/auth/callback
VITE_AUTH_POST_LOGOUT_REDIRECT_URI=http://localhost:5173/
VITE_AUTH_SCOPE=openid profile email
VITE_AUTH_API_SCOPE=

# JWKS validation (backend) for platform/external modes
MOZAIKS_JWKS_URL=https://issuer.example.com/.well-known/jwks.json
MOZAIKS_ISSUER=https://issuer.example.com/
MOZAIKS_AUDIENCE=your-api-audience
MOZAIKS_JWT_ALGORITHMS=RS256

# Optional token exchange (backend).
# - 0: accept external OIDC tokens directly
# - 1: require app-scoped tokens for app APIs (minted via /api/auth/token-exchange)
MOZAIKS_TOKEN_EXCHANGE=0
MOZAIKS_APP_TOKEN_EXPIRE_MINUTES=15

# Claim mappings (backend) for platform/external modes
MOZAIKS_USER_ID_CLAIM=sub
MOZAIKS_EMAIL_CLAIM=email
MOZAIKS_USERNAME_CLAIM=
MOZAIKS_ROLES_CLAIM=roles

# Superadmin mapping (backend): configure a role and/or a boolean claim.
MOZAIKS_SUPERADMIN_ROLE=SuperAdmin
MOZAIKS_SUPERADMIN_CLAIM=

# ----------------------
# Auth Templates (docs)
# ----------------------
#
# Self-hosted OIDC (recommended):
#   MOZAIKS_AUTH_MODE=external
#   VITE_MOZAIKS_AUTH_MODE=external
#   VITE_AUTH_AUTHORITY=https://your-issuer.example.com
#   VITE_AUTH_CLIENT_ID=your-client-id
#   MOZAIKS_JWKS_URL=https://your-issuer.example.com/.well-known/jwks.json
#   MOZAIKS_ISSUER=https://your-issuer.example.com/
#   MOZAIKS_AUDIENCE=your-api-audience
#
# Mozaiks-hosted (platform):
#   MOZAIKS_AUTH_MODE=platform
#   VITE_MOZAIKS_AUTH_MODE=platform
#   # The hosting platform injects the OIDC/JWKS settings for you.
#
# Offline/local:
#   MOZAIKS_AUTH_MODE=local
#   VITE_MOZAIKS_AUTH_MODE=local
#   JWT_SECRET=<strong secret>

# Keycloak (OIDC) example:
#   VITE_AUTH_AUTHORITY=https://<keycloak-host>/realms/<realm>
#   VITE_AUTH_CLIENT_ID=<client-id>
#   MOZAIKS_JWKS_URL=https://<keycloak-host>/realms/<realm>/protocol/openid-connect/certs
#   MOZAIKS_ISSUER=https://<keycloak-host>/realms/<realm>
#   MOZAIKS_AUDIENCE=<client-id-or-audience>

# WorkOS (OIDC) example:
#   VITE_AUTH_AUTHORITY=<workos-issuer-url>
#   VITE_AUTH_CLIENT_ID=<workos-client-id>
#   MOZAIKS_JWKS_URL=<workos-jwks-url>
#   MOZAIKS_ISSUER=<workos-issuer-url>
#   MOZAIKS_AUDIENCE=<workos-client-id-or-audience>

# ┌─────────────────────────────────────────────────────────────────────────┐
# │ LOCAL MODE (OPT-IN ONLY)                                                │
# │ For offline, air-gapped, or open-source self-host distributions.        │
# │ ⚠️  NOT for Mozaiks platform deployments or production use.             │
# │ Requires: MOZAIKS_AUTH_MODE=local AND VITE_MOZAIKS_AUTH_MODE=local      │
# └─────────────────────────────────────────────────────────────────────────┘
JWT_SECRET=change-me-to-a-strong-secret
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# Optional service-to-service auth for admin/internal endpoints.
INTERNAL_API_KEY=

# Admin surface API key (for /__mozaiks/admin/* routes).
# Falls back to INTERNAL_API_KEY if not set.
MOZAIKS_APP_ADMIN_KEY=

################
# App Identity #
################

# App identity used for telemetry and app-scoped tokens / platform integration.
MOZAIKS_APP_ID=

# Per-app API key used for telemetry authentication (preferred).
MOZAIKS_API_KEY=

# SDK version header sent to Insights API (default: 1.0.0).
MOZAIKS_SDK_VERSION=1.0.0


#############################
# Insights Ingestion (Push)  #
#############################

# When enabled, MozaiksCore will periodically POST KPIs + user events to Insights.API.
INSIGHTS_PUSH_ENABLED=0

# Telemetry destination base URL (preferred).
# Docker-to-docker default (set to http://localhost:8060 when calling from host)
INSIGHTS_API_BASE_URL=http://insights.api:8080

# Legacy alias (deprecated).
INSIGHTS_BASE_URL=

# Legacy shared secret sent as: X-Internal-Api-Key: <value> (deprecated).
# If unset, MozaiksCore falls back to INTERNAL_API_KEY.
INSIGHTS_INTERNAL_API_KEY=

# Push cadence and batching.
INSIGHTS_PUSH_INTERVAL_S=60
INSIGHTS_PUSH_BUCKET=1m

# Heartbeat (used to infer sdkConnected/last ping in dashboards).
# - Set INSIGHTS_HEARTBEAT_ENABLED=0 to disable (useful for dev/test).
# - Interval is clamped to >=60s for safety.
INSIGHTS_HEARTBEAT_ENABLED=1
INSIGHTS_HEARTBEAT_INTERVAL_S=60

INSIGHTS_EVENTS_BATCH_SIZE=250
INSIGHTS_EVENTS_INITIAL_LOOKBACK_S=0

############
# Database #
############

# Database Connection
# 1) MONGODB_URI (preferred) - injected by Mozaiks deploy pipeline
# 2) DATABASE_URI (legacy fallback) - manual/local configuration
MONGODB_URI=
DATABASE_URI=mongodb://localhost:27017/MozaiksCore

# Optional override (if you don't include a DB name in the URI):
# DATABASE_NAME=MozaiksCore

# Development-only: allow startup without DB.
MOZAIKS_ALLOW_NO_DB=0

###########################
# Plugins / Runtime Limits #
###########################

# External app content (required for shared runtime)
MOZAIKS_WORKFLOWS_PATH=
MOZAIKS_PLUGINS_PATH=
MOZAIKS_FRONTEND_PLUGINS_PATH=
MOZAIKS_FRONTEND_WORKFLOWS_PATH=
MOZAIKS_CONFIGS_PATH=

# Container runner backend: docker (default) | azure_container_apps
MOZAIKS_CONTAINER_BACKEND=docker

# Azure Container Apps runner configuration (required when MOZAIKS_CONTAINER_BACKEND=azure_container_apps)
MOZAIKS_CONTAINER_APPS_RESOURCE_GROUP=
MOZAIKS_CONTAINER_APPS_ENVIRONMENT=
MOZAIKS_CONTAINER_APPS_SUBSCRIPTION=
MOZAIKS_CONTAINER_APPS_NAME_PREFIX=mozaiks-run

# MozaiksAI Runtime
# MozaiksCore owns the AI runtime; workflows are loaded from MOZAIKS_WORKFLOWS_PATH.
# Base URL for an optional remote runtime API service (required only if running AI runtime elsewhere).
# Example: http://localhost:8090
RUNTIME_BASE_URL=

# Optional: directory containing declarative AI capability specs (JSON files).
# These specs are typically generated upstream during app creation (AppGenerator) and consumed by MozaiksCore at runtime.
# Defaults to `<MOZAIKS_CONFIGS_PATH>/capability_specs` when unset.
MOZAIKS_AI_CAPABILITY_SPECS_DIR=

# Optional: ChatUI base URL if it differs from the API base (e.g., separate origin/service).
# Defaults to RUNTIME_BASE_URL when unset.
MOZAIKS_RUNTIME_UI_BASE_URL=

# ChatUI launch URL template (resolved by /api/ai/launch).
# Supported placeholders:
# - {runtime_ui_base_url} {app_id} {capability_id} {chat_id} {token}
MOZAIKS_CHATUI_URL_TEMPLATE={runtime_ui_base_url}/chat?app_id={app_id}&chat_id={chat_id}&token={token}

# Execution/launch token for MozaiksAI runtime (minted by MozaiksCore in /api/ai/launch).
# MozaiksAI should validate this token (signature + iss/aud) and use its claims as the ExecutionContext.
MOZAIKS_EXECUTION_TOKEN_ALGORITHM=HS256
MOZAIKS_EXECUTION_TOKEN_EXPIRE_MINUTES=10
MOZAIKS_EXECUTION_TOKEN_ISSUER=mozaikscore
MOZAIKS_EXECUTION_TOKEN_AUDIENCE=

# For HS* algorithms (recommended for single-host/self-host deployments): defaults to JWT_SECRET when unset.
MOZAIKS_EXECUTION_TOKEN_SECRET=

# For RS*/ES* algorithms (optional): configure a private key (PEM) via env or file path.
MOZAIKS_EXECUTION_TOKEN_PRIVATE_KEY=
MOZAIKS_EXECUTION_TOKEN_PRIVATE_KEY_PATH=

MOZAIKS_AUTO_REFRESH_PLUGINS=true
PLUGIN_EXEC_TIMEOUT_S=15
PLUGIN_EXEC_MAX_CONCURRENCY=8
MAX_REQUEST_BODY_BYTES=1000000
WEBSOCKET_MAX_CONNECTIONS_PER_USER=5

#################
# Monetization   #
#################

MONETIZATION=0

#############################
# MozaiksPay Managed Mode    #
#############################

# When MOZAIKS_HOSTING_MODE=hosted, MozaiksCore Shell can proxy MozaiksPay through the configured gateway.
MOZAIKS_GATEWAY_BASE_URL=
MOZAIKS_GATEWAY_API_KEY=

# Requires MOZAIKS_APP_ID (set above) for scope=app calls.

# Authentication (platform/external/local) is configured in the "Auth / Tokens" section above.
# In Mozaiks-hosted deployments, the platform provides the OIDC + JWKS settings for you.

###########################
# Notification Channels    #
###########################

# Email service (required for email notifications)
HOSTING_SERVICE=0
EMAIL_SERVICE_URL=
EMAIL_SERVICE_API_KEY=
EMAIL_FROM_ADDRESS=noreply@example.com
EMAIL_FROM_NAME=Mozaiks

# SMS Notifications (Twilio)
# To enable SMS, configure all three: SMS_ACCOUNT_SID, SMS_AUTH_TOKEN, and SMS_FROM_NUMBER
SMS_PROVIDER=twilio
SMS_ACCOUNT_SID=
SMS_AUTH_TOKEN=
SMS_FROM_NUMBER=
SMS_MESSAGING_SERVICE_SID=

# Web Push Notifications (VAPID)
# Generate keys: python -c "from py_vapid import Vapid; v = Vapid(); v.generate_keys(); print('Public:', v.public_key_str); print('Private:', v.private_key_str)"
PUSH_VAPID_PUBLIC_KEY=
PUSH_VAPID_PRIVATE_KEY=
PUSH_VAPID_CLAIMS_EMAIL=mailto:admin@example.com

# Notification Digest Scheduler
NOTIFICATION_DIGEST_ENABLED=true
NOTIFICATION_DIGEST_DAILY_HOUR=9
NOTIFICATION_DIGEST_WEEKLY_DAY=0
