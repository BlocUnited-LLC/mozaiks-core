version: '3.8'

services:
  # ============================================
  # FRONTEND
  # ============================================
  shell:
    build:
      context: ./runtime/packages/shell
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_BASE_URL=http://localhost:8000
      - REACT_APP_WS_URL=ws://localhost:8000
    depends_on:
      - ai-runtime

  # ============================================
  # AI RUNTIME (Python)
  # ============================================
  ai-runtime:
    build:
      context: ./runtime/ai
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MONGODB_URI=mongodb://mongodb:27017/MozaiksDB
      - KEYCLOAK_URL=http://keycloak:8080
      - FRONTEND_URL=http://localhost:3000
      - MOZAIKS_OIDC_DISCOVERY_URL=http://keycloak:8080/realms/mozaiks/.well-known/openid-configuration
      - AUTH_AUDIENCE=mozaiks-api
      - AUTH_ENABLED=true
    depends_on:
      - mongodb

  # ============================================
  # PLUGIN RUNTIME HOST
  # ============================================
  plugin-runtime:
    build:
      context: ./runtime/plugin-host
      dockerfile: Dockerfile
    ports:
      - "8090:8090"
    volumes:
      - ${PLUGINS_MOUNT_PATH:-../mozaiks-platform/plugins}:/plugins:ro
    environment:
      - PLUGINS_DIR=/plugins
      - AUTH_ISSUER=http://keycloak:8080/realms/mozaiks
      - AUTH_JWKS_URL=http://keycloak:8080/realms/mozaiks/protocol/openid-connect/certs
      - AUTH_AUDIENCE=mozaiks-api
      - LOG_LEVEL=INFO
      - MONGODB_URI=mongodb://mongodb:27017
      - PLUGINS_DB_NAME=MozaiksPlugins
    depends_on:
      - mongodb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  billing-api:
    build:
      context: ./backend/src/Billing.API/Payment.API
      dockerfile: Dockerfile
    ports:
      - "8002:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=MozaiksDB
      - Stripe__ApiKey=${STRIPE_API_KEY}
      - Stripe__WebhookSecret=${STRIPE_WEBHOOK_SECRET}
    depends_on:
      - mongodb

  insights-api:
    build:
      context: ./backend/src/Insights.API/Insights.API
      dockerfile: Dockerfile
    ports:
      - "8060:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=MozaiksDB
    depends_on:
      - mongodb

  notification-api:
    build:
      context: ./backend/src/Notification.API/Notification.API
      dockerfile: Dockerfile
    ports:
      - "8007:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=MozaiksDB
      - RabbitMQ__Host=rabbitmq
    depends_on:
      - mongodb
      - rabbitmq

  # ============================================
  # INFRASTRUCTURE
  # ============================================
  mongodb:
    image: mongo:6
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  falkordb:
    image: falkordb/falkordb:latest
    ports:
      - "6380:6379"
    volumes:
      - falkordb_data:/data
    environment:
      - FALKORDB_ARGS=--requirepass ""
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  keycloak:
    build:
      context: ./runtime/ai/keycloak
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=dev-mem
    command: start-dev --import-realm
    volumes:
      - keycloak_data:/opt/keycloak/data

volumes:
  mongodb_data:
  redis_data:
  falkordb_data:
  rabbitmq_data:
  keycloak_data:
