# AG2 Image Generation Capability Integration

## Overview
Integrated AG2's `ImageGeneration` capability to enable DALL-E image generation for runtime agents. This allows agents to generate images conversationally by simply describing what they want - AG2 automatically detects image generation intent and calls DALL-E.

## Implementation Summary

### 1. Core Components

**File: `core/workflow/validation/llm_config.py`**
- Added `get_dalle_llm_config()` function to provide DALL-E-specific LLM config
- Returns llm_config with `dall-e-3` model using same OpenAI API key as GPT models
- Includes extensive logging for debugging: provider lookup, config construction, seed selection

**File: `core/workflow/agents/factory.py`**
- Added `extract_images_from_conversation()` utility to parse GPT-4V message format
- Extracts PIL Image objects from conversation history (for retrieving generated images)
- Added capability attachment logic (lines 451-510):
  * Checks `agent_config.get("image_generation_enabled", False)`
  * Imports `autogen.agentchat.contrib.capabilities.generate_images`
  * Calls `get_dalle_llm_config()` to build DALL-E config
  * Creates `DalleImageGenerator(llm_config, resolution="1024x1024", quality="standard")`
  * Creates `ImageGeneration(image_generator, text_analyzer_llm_config)`
  * Attaches capability to agent via `image_capability.add_to_agent(agent)`
  * Sets `_mozaiks_has_image_generation` flag for runtime introspection
- Comprehensive logging at every step (8+ log statements):
  * Import confirmation
  * Config build success
  * Generator creation
  * Capability creation
  * Attachment success
  * Error handling (ImportError, Exception)

### 2. Configuration Pattern

**Boolean Flag Approach (Simplified)**
```python
# In agents.json (generated by AgentsAgent during workflow generation)
{
  "name": "ThumbnailAgent",
  "image_generation_enabled": true,  # <-- Simple flag
  "auto_tool_mode": true,
  "structured_outputs_required": false,
  ...
}
```

This replaced an earlier complex capability system with registries and JSON schemas.

### 3. AG2 Capability Pattern

**How It Works:**
1. Agent describes desired image in conversation text
2. AG2's `TextAnalyzerAgent` (part of ImageGeneration capability) detects image intent
3. Capability automatically calls `DalleImageGenerator`
4. DALL-E renders image and returns URL
5. Image appears in conversation as GPT-4V message format (content array with image_url)
6. Use `extract_images_from_conversation()` to retrieve generated images when needed

**Example Usage:**
```python
# Agent with capability enabled (conversational image generation)
agent_config = {
    "name": "ThumbnailAgent",
    "image_generation_enabled": true,
    "system_message": "[ROLE] You generate thumbnails using DALL-E..."
}

# Agent simply describes image in conversation
agent.generate_reply(messages=[{
    "role": "user",
    "content": "Generate a cinematic thumbnail showing a sunset over mountains"
}])

# AG2 ImageGeneration capability detects intent and calls DALL-E
# Result: Image URL appears in conversation history
```

### 4. StoryCreator Workflow Integration

**Script: `scripts/08_update_agent_contexts_dream_visualizer.py`**
- Updated AgentsAgent EXAMPLE section to include ThumbnailAgent with `image_generation_enabled: true`
- When Generator workflow runs, AgentsAgent will produce StoryCreator agents.json with capability flag
- ThumbnailAgent will be created with DALL-E capability attached

**Example Generated Config:**
```json
{
  "name": "ThumbnailAgent",
  "display_name": "Thumbnail Generator",
  "system_message": "[ROLE] You generate story thumbnails using DALL-E AI image generation...",
  "max_consecutive_auto_reply": 5,
  "auto_tool_mode": true,
  "structured_outputs_required": false,
  "image_generation_enabled": true
}
```

### 5. Logging Infrastructure

All capability operations are logged with structured prefixes:

```
[DALLE_CONFIG] Building DALL-E LLM config...
[DALLE_CONFIG] Loaded 3 LLM providers from config_list
[DALLE_CONFIG] Found existing DALL-E entry: dall-e-3
[DALLE_CONFIG] Final config: model=dall-e-3, cache_seed=12345

[AGENTS][CAPABILITY] Image generation enabled for ThumbnailAgent - attaching AG2 capability
[AGENTS][CAPABILITY] Imported AG2 generate_images module for ThumbnailAgent
[AGENTS][CAPABILITY] Built DALL-E config for ThumbnailAgent: model=dall-e-3
[AGENTS][CAPABILITY] Created DalleImageGenerator for ThumbnailAgent
[AGENTS][CAPABILITY] Created ImageGeneration capability for ThumbnailAgent
[AGENTS][CAPABILITY] ✓ Successfully attached image generation capability to ThumbnailAgent (DALL-E model=dall-e-3, resolution=1024x1024)

[IMAGE_EXTRACT] Scanning 5 messages for images
[IMAGE_EXTRACT] Found image in message 3 (url type)
[IMAGE_EXTRACT] Extracted 1 images from conversation
```

### 6. Error Handling

**Missing Dependencies:**
```python
try:
    from autogen.agentchat.contrib.capabilities import generate_images
except ImportError as imp_err:
    logger.error(
        f"Failed to import AG2 image generation: {imp_err}. "
        f"Install with: pip install ag2[lmm,openai]"
    )
    raise
```

**Capability Attachment Failures:**
```python
except Exception as cap_err:
    logger.error(
        f"Failed to attach image generation capability: {cap_err}",
        exc_info=True  # Full stack trace for debugging
    )
    raise
```

### 7. Runtime Introspection

**Capability Flag:**
```python
# Check if agent has image generation capability
if hasattr(agent, "_mozaiks_has_image_generation") and agent._mozaiks_has_image_generation:
    logger.info(f"{agent.name} has DALL-E capability enabled")
```

## Configuration Requirements

### OpenAI API Key
- Same API key used for GPT models (`OPENAI_API_KEY` in .env)
- No separate DALL-E key needed
- Ensure sufficient quota for image generation

### Model Configuration
- Model: `dall-e-3` (hardcoded, can be made configurable)
- Resolution: `1024x1024` (default, can be made configurable via agent_config)
- Quality: `standard` (default, can be made configurable via agent_config)
- Num Images: `1` (default, can be made configurable)

## Testing Checklist

- [ ] Run Generator workflow to create StoryCreator
- [ ] Verify ThumbnailAgent has `image_generation_enabled: true` in generated agents.json
- [ ] Check logs for `[AGENTS][CAPABILITY]` messages during agent creation
- [ ] Run StoryCreator workflow with thumbnail generation
- [ ] Verify DALL-E capability detects image intent
- [ ] Check `[IMAGE_EXTRACT]` logs when retrieving generated images
- [ ] Test error handling with missing dependencies
- [ ] Verify capability flag `_mozaiks_has_image_generation` is set

## Future Enhancements

### Configurable Image Parameters
```python
# Make resolution/quality configurable via agent_config
{
  "image_generation_enabled": true,
  "image_generation_config": {
    "resolution": "1792x1024",  # Wide format
    "quality": "hd",            # High definition
    "num_images": 2             # Generate multiple options
  }
}
```

### Multiple Image Generator Support
```python
# Support different image generation backends
{
  "image_generation_enabled": true,
  "image_generator": "dalle3" | "midjourney" | "stable-diffusion"
}
```

### Image Post-Processing
```python
# Add post-processing capabilities
{
  "image_generation_enabled": true,
  "image_processing": {
    "resize": true,
    "watermark": true,
    "thumbnail_sizes": ["256x256", "512x512"]
  }
}
```

## References

- AG2 ImageGeneration docs: `autogen/agentchat/contrib/capabilities/generate_images.py`
- DalleImageGenerator class: Uses OpenAI DALL-E API
- GPT-4V message format: Content arrays with image_url entries
- PIL Image handling: `extract_images_from_conversation()` utility

## Architecture Notes

**Separation of Concerns:**
- `get_dalle_llm_config()`: LLM config provider (no agent coupling)
- `extract_images_from_conversation()`: Passive utility (no side effects)
- Capability attachment: Factory pattern in `create_agents()` (single responsibility)

**Config Separation:**
- Main llm_config: GPT-4o-mini for reasoning/text analysis
- DALL-E config: dall-e-3 for image generation
- Reuses same OpenAI API key (simplifies auth)

**Logging Philosophy:**
- All operations logged at appropriate levels (DEBUG, INFO, ERROR)
- Structured prefixes for easy filtering (`[DALLE_CONFIG]`, `[AGENTS][CAPABILITY]`, `[IMAGE_EXTRACT]`)
- No secrets logged (API keys, credentials)
- Full stack traces on errors (`exc_info=True`)

## Status

✅ **COMPLETE** - All implementation and logging infrastructure in place
✅ **TESTED** - Script run successfully, examples updated
⏳ **PENDING** - End-to-end workflow test (requires running Generator → StoryCreator)
