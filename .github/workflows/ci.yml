name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "8.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  build-backend:
    name: Build Backend (.NET)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore MozaiksCore.sln
        working-directory: ./
      
      - name: Build
        run: dotnet build MozaiksCore.sln --no-restore --configuration Release
        working-directory: ./
      
      - name: Test
        run: dotnet test MozaiksCore.sln --no-build --configuration Release --verbosity normal
        working-directory: ./

  # build-shell:
  #   name: Build Shell (React)
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v6
  #       with:
  #         node-version: "20"
  #         cache: "npm"
  #         cache-dependency-path: shell/package-lock.json
  #     
  #     - name: Install dependencies
  #       run: npm ci
  #       working-directory: ./shell
  #     
  #     - name: Lint
  #       run: npm run lint
  #       working-directory: ./shell
  #       continue-on-error: true
  #     
  #     - name: Build
  #       run: npm run build
  #       working-directory: ./shell

  build-ai-runtime:
    name: Build AI Runtime (Python)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        working-directory: ./runtime/ai
        continue-on-error: true
      
      - name: Lint
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        working-directory: ./runtime/ai
        continue-on-error: true

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [build-backend]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Identity API
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/src/Identity.API/AuthServer.Api/Dockerfile
          push: false
          tags: mozaiks-core/identity-api:test
        continue-on-error: true
      
      - name: Build Billing API
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/src/Billing.API/Payment.API/Dockerfile
          push: false
          tags: mozaiks-core/billing-api:test
        continue-on-error: true
